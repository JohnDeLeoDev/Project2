<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>CS 4731 Final Project Part I</title>

        <script id="main-vshader" type="x-shader/x-vertex">
            attribute vec4 vPosition;  //
            attribute vec4 vNormal; //
            attribute vec2 vTexCoord; //
            attribute vec4 diffuseColor; //
            attribute vec4 specularColor; //
            attribute vec4 ambientColor; //

            uniform mat4 cameraView; //
            uniform mat4 cameraProjection; //
            uniform mat4 modelTranslation; //
            uniform mat4 modelRotation; //
            uniform mat4 modelScale; //

            uniform mat4 shadowMatrix; //

            varying highp vec2 fTexCoord;
            varying vec4 fDiffuseColor;
            varying vec4 fSpecularColor;
            varying vec4 fAmbientColor;
            varying vec4 vPositionInLightSpace;
            varying vec4 fNormal;
            varying vec4 fPosition;

            varying vec4 vProjectedTexCoords;

            void main(void) {
                fTexCoord = vTexCoord;

                fDiffuseColor = diffuseColor;
                fSpecularColor = specularColor;
                fAmbientColor = ambientColor;

                fNormal = normalize(modelRotation * vNormal);

                // position of the vertex in the world space
                fPosition = modelTranslation * modelRotation * modelScale * vPosition;

                vProjectedTexCoords = shadowMatrix * fPosition;

                // position of the vertex in the camera space
                gl_Position = cameraProjection * cameraView * fPosition;
            }
        </script>

        <script id="main-fshader" type="x-shader/x-fragment">
            precision mediump float;

            uniform sampler2D modelTexture; //
            uniform sampler2D shadowTexture; //
            uniform samplerCube skyboxTexture; //

            uniform bool useTexture; //

            varying vec4 fNormal;
            varying vec4 fDiffuseColor;
            varying vec4 fSpecularColor;
            varying vec4 fAmbientColor;
            varying vec4 vPositionInLightSpace;
            varying vec4 fPosition;
            varying highp vec2 fTexCoord;
            varying vec4 vProjectedTexCoords;

            uniform vec4 lightPosition; //
            uniform vec4 lightAmbient; //
            uniform vec4 lightDiffuse; //
            uniform vec4 lightSpecular; //

            uniform bool lightOn; //
            uniform bool shadowEnable; //
            uniform bool additionalBias; //

            void main(void) {

                float bias = 0.0;

                vec3 shadowCoord = vProjectedTexCoords.xyz / vProjectedTexCoords.w;
                // find current fragment depth
                float fDepth = shadowCoord.z;

                float shadowDepth = texture2D(shadowTexture, shadowCoord.xy).z;

                float shadowColor = fDepth > shadowDepth + bias ? 0.2 : 0.0;

                vec4 shadowColorVec = vec4(shadowColor, shadowColor, shadowColor, 0.0);

                vec4 texColor = useTexture ? texture2D(modelTexture, fTexCoord) : vec4(1.0);

                vec4 normal = normalize(fNormal);
                vec4 lightDir = normalize(lightPosition - fPosition);
                vec4 reflectDir = reflect(-lightDir, normal);
                vec4 viewDir = normalize(-fPosition);
                float spec = pow(max(dot(viewDir, reflectDir), 0.0), 32.0);

                vec4 ambient = lightAmbient * fAmbientColor;
                vec4 diffuse = lightDiffuse * fDiffuseColor * max(dot(normal, lightDir), 0.0);
                vec4 specular = lightSpecular * fSpecularColor * spec;

                if (!lightOn) {
                    diffuse = vec4(0.0, 0.0, 0.0, 1.0);
                    specular = vec4(0.0, 0.0, 0.0, 1.0);
                }

                gl_FragColor = ((ambient + diffuse + specular) * texColor) - shadowColorVec;

            }
        </script>

        <script id="shadow-vshader" type="x-shader/x-vertex">
            attribute vec4 vPosition;  // position of the vertex in model space

            // light transformation matrices
            uniform mat4 lightView; // view matrix of the light
            uniform mat4 lightProjection; // projection matrix of the light

            // world transformation matrices
            uniform mat4 modelTranslation; // translation matrix of the model
            uniform mat4 modelRotation; // rotation matrix of the model
            uniform mat4 modelScale; // scale matrix of the model

            varying vec4 fPosition; // position of the vertex in the world space

            varying vec4 vPositionInLightSpace;

            void main(void) {
                // position of the vertex in the world space
                fPosition = modelTranslation * modelRotation * modelScale * vPosition;

                vPositionInLightSpace = lightProjection * lightView * fPosition;


                // position of the vertex in the camera space
                gl_Position = lightProjection * lightView * fPosition;
            }
        </script>

        <script id="shadow-fshader" type="x-shader/x-fragment">
            precision mediump float;

            varying vec4 fPosition; // position of the vertex in the world space

            void main(void) {

                vec4 uColor = vec4(1.0, 1.0, 1.0, 1.0);

                gl_FragColor = uColor;
            }
        </script>

        <script id="skybox-vshader" type="x-shader/x-vertex">
            attribute vec4 vPosition;  // position of the vertex in model space

            uniform mat4 cameraView; // view matrix of the camera
            uniform mat4 cameraProjection; // projection matrix of the camera

            uniform mat4 modelTranslation; // translation matrix of the model
            uniform mat4 modelRotation; // rotation matrix of the model
            uniform mat4 modelScale; // scale matrix of the model


            varying vec4 fPosition; // position of the vertex in the world space

            void main(void) {
                // position of the vertex in the world space
                fPosition = vPosition;

                vec3 fPosition3 = vec3(fPosition);

                // position of the vertex in the camera space
                gl_Position = cameraProjection * cameraView * vec4(fPosition3, 0.1);
            }
        </script>

        <script id="skybox-fshader" type="x-shader/x-fragment">
            precision mediump float;

            uniform samplerCube skyboxTexture; // texture of the skybox

            varying vec4 fPosition; // position of the vertex in the world space

            void main(void) {
                gl_FragColor = textureCube(skyboxTexture, fPosition.xyz);
            }
        </script>

        <script type="text/javascript" src="lib/webgl-utils.js"></script>
        <script type="text/javascript" src="lib/initShaders.js"></script>
        <script type="text/javascript" src="lib/MV.js"></script>

        <script type="text/javascript" src="lib/model.js"></script>
        <script type="text/javascript" src="lib/face.js"></script>
        <script type="text/javascript" src="lib/camera.js"></script>
        <script type="text/javascript" src="lib/shaders.js"></script>
        <script type="text/javascript" src="lib/light.js"></script>
        <script type="text/javascript" src="lib/skybox.js"></script>

        <script type="text/javascript" src="main.js"></script>
    </head>

    <body>
        <h1 id="mode">CS 4731 Final Project</h1>

        <canvas id="webgl" class="box" width="800" height="800">
            Please use a browser that supports the "canvas" tag.
        </canvas>
    </body>
</html>
